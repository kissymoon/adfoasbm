<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase å¤šäººå®æ—¶åŒæ­¥ç”»æ¿2</title>
    <style>
        /* æ ·å¼ï¼šå…¨å±ç”»æ¿ï¼Œç¦æ­¢æ»šåŠ¨ */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: #fff;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        canvas {
            display: block;
            background: #fff;
            cursor: crosshair;
            touch-action: none; /* é˜²æ­¢ç§»åŠ¨ç«¯æ‹–æ‹½é¡µé¢ */
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <strong>ğŸ¨ å®æ—¶åä½œç”»æ¿</strong>
        <span id="status">è¿æ¥ä¸­...</span>
        <button onclick="clearCanvas()">æ¸…ç©ºæˆ‘çš„ç”»å¸ƒ</button>
    </div>

    <canvas id="paintCanvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
const SUPABASE_URL = 'https://xqrksvjqeqhccltazpuw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmtzdmpxZXFoY2NsdGF6cHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODI3NzIsImV4cCI6MjA4MTU1ODc3Mn0.LBW8fjHnpyF2TLWz_Lgwk89rdbnHS7uQT-2EMME7Ca8';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const canvas = document.getElementById('paintCanvas');
const ctx = canvas.getContext('2d');
// ... (ä¿ç•™ä¹‹å‰çš„ resizeCanvas ä»£ç ) ...

let isDrawing = false;
let currentLinePoints = []; // è®°å½•å½“å‰è¿™ä¸€ç¬”çš„æ‰€æœ‰ç‚¹
const myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

// --- 1. åˆå§‹åŒ–ï¼šåŠ è½½å†å²æ•°æ® ---
async function loadHistory() {
    const { data, error } = await supabaseClient
        .from('drawing_lines')
        .select('*');
    
    if (data) {
        data.forEach(line => {
            drawFullLine(line.points, line.color);
        });
    }
}
loadHistory();

// --- 2. å®æ—¶ç›‘å¬ï¼šæ•°æ®åº“æœ‰æ–°è¡Œæ’å…¥æ—¶ ---
supabaseClient
    .channel('schema-db-changes')
    .on('postgres_changes', 
        { event: 'INSERT', schema: 'public', table: 'drawing_lines' }, 
        payload => {
            const newLine = payload.new;
            drawFullLine(newLine.points, newLine.color);
        }
    )
    .subscribe();

// --- 3. ç»˜å›¾æ ¸å¿ƒé€»è¾‘ ---

function drawFullLine(points, color) {
    if (points.length < 2) return;
    ctx.beginPath();
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i].x, points[i].y);
    }
    ctx.stroke();
}

function handleStart(x, y) {
    isDrawing = true;
    currentLinePoints = [{ x, y }];
}

function handleMove(x, y) {
    if (!isDrawing) return;
    const lastPos = currentLinePoints[currentLinePoints.length - 1];
    const currentPos = { x, y };
    
    // æœ¬åœ°å³æ—¶æ¸²æŸ“ï¼ˆé¡ºæ»‘æ„Ÿï¼‰
    ctx.beginPath();
    ctx.strokeStyle = myColor;
    ctx.moveTo(lastPos.x, lastPos.y);
    ctx.lineTo(currentPos.x, currentPos.y);
    ctx.stroke();

    currentLinePoints.push(currentPos);
}

async function handleEnd() {
    if (!isDrawing) return;
    isDrawing = false;

    // --- 4. å…³é”®ï¼šå°†æ•´æ¡çº¿å­˜å…¥æ•°æ®åº“ ---
    if (currentLinePoints.length > 1) {
        await supabaseClient
            .from('drawing_lines')
            .insert([{ points: currentLinePoints, color: myColor }]);
    }
    currentLinePoints = [];
}

// ç»‘å®šäº‹ä»¶ (åŒä¹‹å‰ä»£ç )
canvas.addEventListener('mousedown', e => handleStart(e.offsetX, e.offsetY));
canvas.addEventListener('mousemove', e => handleMove(e.offsetX, e.offsetY));
window.addEventListener('mouseup', handleEnd);
    </script>
</body>

</html>


