<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>25ÂïÜËã±1Áè≠ÂÖ±ÂêåÁªò‰Ωú</title>
    <style>
        body { margin: 0; background: #050510; overflow: hidden; touch-action: none; font-family: sans-serif; }
        canvas { position: absolute; top: 0; left: 0; }
        .toolbar {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            padding: 12px 20px;
            z-index: 100;
            display: flex;
            gap: 20px;
            align-items: center;
            color: rgba(255,255,255,0.8);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #status { font-weight: bold; font-size: 0.9em; }
        .debug-btn { 
            background: rgba(255, 71, 87, 0.2); 
            color: #ff4757; 
            border: 1px solid #ff4757; 
            padding: 4px 12px; 
            border-radius: 20px; 
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.8em;
        }
        .debug-btn:hover { background: #ff4757; color: white; }
    </style>
</head>
<body>

    <div class="toolbar">
        <strong>25ÂïÜËã±1Áè≠ÂÖ±ÂêåÁªò‰Ωú</strong>
        <span id="status">ËøûÊé•‰∏≠...</span>
    </div>

    <canvas id="bgCanvas"></canvas>
    <canvas id="canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://xqrksvjqeqhccltazpuw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxcmtzdmpxZXFoY2NsdGF6cHV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5ODI3NzIsImV4cCI6MjA4MTU1ODc3Mn0.LBW8fjHnpyF2TLWz_Lgwk89rdbnHS7uQT-2EMME7Ca8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        const statusEl = document.getElementById('status');

        let particles = [];
        let currentStroke = []; 
        let isDrawing = false;
        
        // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÊØè‰∏™‰∫∫ËøõÊù•ÈöèÊú∫‰∏Ä‰∏™È¢úËâ≤Ëµ∑ÁÇπ ---
        let myBaseHue = Math.random() * 360; 
        let currentHue = myBaseHue; 

        let hasDrawn = localStorage.getItem('user_has_drawn_stardust') === 'true';

        function init() {
            canvas.width = bgCanvas.width = window.innerWidth;
            canvas.height = bgCanvas.height = window.innerHeight;
            bgCtx.fillStyle = '#050510';
            bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
            updateStatusUI();
        }

        class Particle {
            constructor(x, y, hue, isPermanent = false) {
                this.x = x;
                this.y = y;
                this.hue = hue;
                this.size = Math.random() * 2 + 0.5;
                this.life = 1.0;
                this.decay = Math.random() * 0.015 + 0.01;
                this.vx = (Math.random() - 0.5) * 0.8;
                this.vy = (Math.random() - 0.5) * 0.8;
                this.isPermanent = isPermanent;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
            }

            draw(targetCtx, centerX, centerY, count) {
                for (let i = 0; i < count; i++) {
                    targetCtx.save();
                    targetCtx.translate(centerX, centerY);
                    targetCtx.rotate((Math.PI * 2 / count) * i);
                    
                    const drawX = this.x - centerX;
                    const drawY = this.y - centerY;

                    // Â£ÅÁîªËΩ®ËøπÈÄèÊòéÂ∫¶ËæÉ‰ΩéÔºå‰∫ßÁîüÂ†ÜÂè†ÊÑüÔºõÂä®ÊÄÅÁ≤íÂ≠êËæÉ‰∫Æ
                    targetCtx.globalAlpha = this.isPermanent ? 0.2 : this.life;
                    targetCtx.beginPath();
                    targetCtx.arc(drawX, drawY, this.size, 0, Math.PI * 2);
                    targetCtx.fillStyle = `hsla(${this.hue}, 85%, 75%, ${this.life})`;
                    
                    if(!this.isPermanent) {
                        targetCtx.shadowBlur = 12;
                        targetCtx.shadowColor = `hsla(${this.hue}, 80%, 70%, 0.8)`;
                    }
                    
                    targetCtx.fill();
                    targetCtx.restore();
                }
            }
        }

        const channel = supabaseClient.channel('drawing_room');

        channel.on('broadcast', { event: 'draw_stardust' }, (payload) => {
            const { points, startHue } = payload.payload;
            renderRemoteStroke(points, startHue);
        }).subscribe((status) => {
            if (status === 'SUBSCRIBED') updateStatusUI();
        });

        // Ê∏≤Êüì‰ªñ‰∫∫ÁöÑÁ¨îËß¶
        function renderRemoteStroke(points, startHue) {
            let tempHue = startHue;
            points.forEach(p => {
                for(let i=0; i<1; i++) {
                    const part = new Particle(p.x, p.y, tempHue, true);
                    particles.push(part);
                    part.draw(bgCtx, bgCanvas.width/2, bgCanvas.height/2, 8);
                }
                tempHue += 0.2;
            });
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw(ctx, canvas.width / 2, canvas.height / 2, 8);
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(animate);
        }

        function createParticles(x, y) {
            if (!isDrawing || hasDrawn) return;
            
            currentStroke.push({x, y});
            
            for(let i=0; i<2; i++) {
                const p = new Particle(x, y, currentHue, true);
                particles.push(p);
                p.draw(bgCtx, bgCanvas.width/2, bgCanvas.height/2, 8);
            }
            currentHue += 0.2; // Âêå‰∏ÄÁ¨îÂÜÖÈ¢úËâ≤Ê∏êÂèò
        }

        function handleStart(e) {
            if (hasDrawn) return;
            isDrawing = true;
            currentStroke = [];
            // ÊØèÊ¨°Êñ∞ÁöÑ‰∏ÄÁ¨îÂèØ‰ª•ÈáçÊñ∞Èöè‰∏Ä‰∏™Ëâ≤Áõ∏ÔºåÊàñËÄÖÊ≤øÁî®‰πãÂâçÁöÑËâ≤Áõ∏
            // ËøôÈáåÊàë‰ª¨ËÆ©ÊØèÁ¨îÂºÄÂßãÊó∂ÁöÑËâ≤Áõ∏Á®çÂæÆË∑≥Ë∑É‰∏ÄÁÇπÁÇπÔºåÂ¢ûÂä†Â§öÊ†∑ÊÄß
            currentHue = myBaseHue + (Math.random() * 30 - 15); 
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);
            createParticles(x, y);
        }

        function handleEnd() {
            if (isDrawing) {
                isDrawing = false;
                hasDrawn = true;
                localStorage.setItem('user_has_drawn_stardust', 'true');
                updateStatusUI();

                // ÂπøÊí≠ËøôÊï¥Á¨îÁöÑËΩ®ËøπÂíåÈ¢úËâ≤Ëµ∑ÁÇπ
                channel.send({
                    type: 'broadcast',
                    event: 'draw_stardust',
                    payload: { 
                        points: currentStroke, 
                        startHue: currentHue - (currentStroke.length * 0.2) 
                    }
                });
            }
        }

        function updateStatusUI() {
            if (hasDrawn) {
                statusEl.innerText = 'üö´ ÁïôÂ¢®ÂÆåÊàê';
                statusEl.style.color = '#ff4757';
            } else {
                statusEl.innerText = 'üü¢ ËØ∑Êå•Ê¥íÊòüÂ∞ò';
                statusEl.style.color = '#2ecc71';
            }
        }

        function resetLimit() {
            localStorage.removeItem('user_has_drawn_stardust');
            hasDrawn = false;
            // ÈáçÁΩÆËÉåÊôØÈ¢úËâ≤ÔºåÊ∏ÖÁ©∫ÁîªÂ∏É
            bgCtx.fillStyle = '#050510';
            bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
            myBaseHue = Math.random() * 360; // ÈáçÁΩÆÊó∂‰πüÊç¢‰∏™‰∏ªËâ≤Ë∞É
            updateStatusUI();
        }

        canvas.addEventListener('mousedown', handleStart);
        window.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mousemove', (e) => createParticles(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => { handleStart(e); e.preventDefault(); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { 
            const t = e.touches[0];
            createParticles(t.clientX, t.clientY); 
            e.preventDefault(); 
        }, { passive: false });
        canvas.addEventListener('touchend', handleEnd);

        init();
        animate();
        window.addEventListener('resize', init);
    </script>
</body>
</html>
